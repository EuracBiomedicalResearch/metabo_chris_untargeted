---
title: "Peak filling of the untargeted metabolomics data from CHRIS"
author: "Mar Garcia-Aloy, Johannes Rainer"
output: 
  BiocStyle::html_document:
    toc: true
    number_sections: false
    toc_float: true
---

```{r startpoint, include = FALSE}
startpoint <- Sys.time()
```

In this document we're going to do the peak filling of the samples from CHRIS with XCMS.  
For this study, peak detection, aligment and correspondence have already been done. 


# Preliminaries

We define the specific parameters for the current study, 
We load all required libraries, and we set up the parallel processing.

## Parameters

```{r parameters}
polarity <- "POS" # specify "POS" or "NEG"
```

## Libraries

```{r libraries, message = FALSE}
library(doParallel)
library(xcms)
```

## Parallel processing

```{r parallel, eval = TRUE}
ncores <- Sys.getenv("SLURM_JOB_CPUS_PER_NODE", 3)
register(bpstart(MulticoreParam(ncores)))
#register(SerialParam())
```

## Data import

```{r}
load(paste0("data/data_XCMS_", polarity,".RData"))
```


# Peak filling

Next I fill-in missing peak data (ie, data for samples in which no peak was detected) 
from an m/z - retention time slice defined by
the m/z range of the feature and the retention time window of the feature
definition that is extended by a constant value (i.e. the median retention time
width of all identified peaks). The retention time window from which the signal is
integrated should be expanded, because the feature's retention time range
represents the minimal and maximal apex position of the associated peaks in the
time dimension, and is thus unrelated to the actual retention time width of the
peaks. The m/z range is also extended by 20ppm.

```{r filling, eval = TRUE}
rtwidths <- chromPeaks(xdata)[, "rtmax"] - chromPeaks(xdata)[, "rtmin"]
fcp <- FillChromPeaksParam(
  ppm = 20, fixedRt = median(rtwidths) / 2)
xdata <- fillChromPeaks(xdata, param = fcp)
```


# Save data

```{r save, eval = TRUE}
save(xdata, file = paste0("data/data_XCMS_filled_", polarity,".RData"))
```


# Session information

```{r session}
Sys.time()-startpoint

devtools::session_info()
```
